<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathjelper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="antialiased">
    <header id="mainHeader" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 shadow-md flex flex-col items-center justify-center rounded-b-xl mb-6 lg:flex-row lg:justify-start lg:px-8 lg:py-6">
        <img src="./logo.png" alt="De Godes Mat Logo" class="h-24 w-24 rounded-lg shadow-md mb-4 lg:mb-0 lg:mr-6">
        <h1 class="text-3xl font-bold text-center lg:text-left">Mathjelper av velging av oppskrifter</h1>
    </header>

    <div class="main-content-area flex flex-col lg:flex-row lg:space-x-6">
        <div class="w-full max-w-md p-4 bg-white rounded-xl shadow-lg flex flex-col items-center space-y-3 mb-6 lg:mb-0 lg:mr-6">
            <div class="w-full flex items-center space-x-3">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Søk etter ingredienser..."
                    class="flex-grow px-4 py-2 text-gray-800 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out"
                    aria-label="Søkefelt for ingredienser"
                >
                <button
                    id="searchButton"
                    class="flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                    aria-label="Søkeknapp"
                >
                    Søk
                </button>
            </div>

            <div id="searchResults" class="w-full p-4 bg-gray-50 rounded-xl mt-4 hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Søkeresultater:</h2>
                <ul id="resultsList" class="list-disc pl-5 text-gray-700">
                </ul>
                <p id="noResultsMessage" class="text-gray-500 italic hidden">Ingen ingredienser funnet.</p>
            </div>
        </div>

        <div class="w-full max-w-md flex flex-col space-y-6">
            <div id="selectedIngredientsContainer" class="p-4 bg-white rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-800">Valgte Ingredienser:</h2>
                    <button
                        id="clearSelectedButton"
                        class="p-2 rounded-full hover:bg-gray-100 transition duration-200 ease-in-out"
                        aria-label="Fjern alle valgte ingredienser"
                    >
                        <img src="./bin.jpg" alt="Fjern alle" class="h-8 w-8">
                    </button>
                </div>
                <ul id="selectedIngredientsList" class="text-gray-700">
                </ul>
                <p id="noSelectedIngredientsMessage" class="text-gray-500 italic">Ingen ingredienser valgt.</p>
            </div>

            <div id="suggestedRecipesContainer" class="p-4 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Foreslåtte Oppskrifter:</h2>
                <div id="mealTypeFilters" class="flex flex-wrap gap-2 mb-4">
                    <button class="filter-button active" data-filter="alle">Alle</button>
                    <button class="filter-button" data-filter="middag">Middag</button>
                    <button class="filter-button" data-filter="frokost">Frokost</button>
                    <button class="filter-button" data-filter="dessert">Dessert</button>
                    <button class="filter-button" data-filter="kaker">Kaker</button>
                    <button class="filter-button" data-filter="suppe">Supper</button>
                    <button class="filter-button" data-filter="saus">Saus</button>
                    <button class="filter-button" data-filter="tilbehør">Tilbehør</button>
                </div>
                <div id="recipesList" class="text-gray-700">
                </div>
                <p id="noSuggestedRecipesMessage" class="text-gray-500 italic">Legg til ingredienser for å få oppskriftsforslag.</p>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
    </div>

    <div id="customModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button id="modalCloseButton">Lukk</button>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const searchResultsDiv = document.getElementById('searchResults');
        const resultsList = document.getElementById('resultsList');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const selectedIngredientsList = document.getElementById('selectedIngredientsList');
        const noSelectedIngredientsMessage = document.getElementById('noSelectedIngredientsMessage');
        const recipesList = document.getElementById('recipesList');
        const noSuggestedRecipesMessage = document.getElementById('noSuggestedRecipesMessage');
        const mealTypeFilters = document.getElementById('mealTypeFilters');
        const loadingOverlay = document.getElementById('loadingOverlay'); // Loading overlay element
        const customModal = document.getElementById('customModal'); // Custom modal overlay
        const modalTitle = document.getElementById('modalTitle'); // Modal title element
        const modalMessage = document.getElementById('modalMessage'); // Modal message element
        const modalCloseButton = document.getElementById('modalCloseButton'); // Modal close button
        const clearSelectedButton = document.getElementById('clearSelectedButton'); // New: Clear all button

        // Global variables to hold data after loading
        let allIngredientsData = [];
        let recipesData = [];

        // Array to hold the selected ingredients
        let selectedIngredients = [];
        // Variable to hold the active meal type filter
        let currentMealTypeFilter = 'alle'; // Default: show all

        /**
         * Displays the custom modal with a given title and message.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content of the modal.
         */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModal.classList.add('show'); // Add 'show' class to make it visible
            customModal.classList.remove('hidden'); // Ensure it's not hidden by Tailwind
        }

        /**
         * Hides the custom modal.
         */
        function hideModal() {
            customModal.classList.remove('show'); // Remove 'show' class to hide it
            // Add 'hidden' class after a short delay to allow transition to complete
            setTimeout(() => {
                customModal.classList.add('hidden');
            }, 300); // Match CSS transition duration
        }

        // Event listener for the modal close button
        modalCloseButton.addEventListener('click', hideModal);


        /**
         * Renders the list of selected ingredients in the UI.
         * Updates the visibility of the "no selected ingredients" message.
         * Triggers recipe suggestions after rendering.
         */
        function renderSelectedIngredients() {
            selectedIngredientsList.innerHTML = ''; // Clear the list
            if (selectedIngredients.length === 0) {
                noSelectedIngredientsMessage.classList.remove('hidden'); // Show message if no ingredients selected
            } else {
                noSelectedIngredientsMessage.classList.add('hidden'); // Hide the message
                selectedIngredients.forEach(ingredient => {
                    const listItem = document.createElement('li');
                    // Capitalize the first letter for display
                    listItem.textContent = ingredient.charAt(0).toUpperCase() + ingredient.slice(1);
                    listItem.classList.add('flex', 'items-center', 'justify-between'); // Tailwind for flex layout

                    // Add a "remove" button
                    const removeButton = document.createElement('span');
                    removeButton.textContent = 'X';
                    removeButton.classList.add('remove-btn');
                    removeButton.title = `Fjern ${ingredient}`; // Accessibility
                    removeButton.addEventListener('click', (event) => {
                        event.stopPropagation(); // Prevent the click from bubbling up to listItem
                        removeIngredientFromSelectedList(ingredient);
                    });

                    listItem.appendChild(removeButton);
                    selectedIngredientsList.appendChild(listItem);
                });
            }
            suggestRecipes(); // Call to update recipe suggestions when ingredients change
        }

        /**
         * Adds an ingredient to the selected ingredients list.
         * Prevents duplicates.
         * @param {string} ingredient - The ingredient to add.
         */
        function addIngredientToSelectedList(ingredient) {
            // Check if the ingredient is already in the list to avoid duplicates
            if (!selectedIngredients.includes(ingredient)) {
                selectedIngredients.push(ingredient);
                renderSelectedIngredients(); // Update the display
                console.log(`Added to selected list: ${ingredient}`);
            } else {
                console.log(`${ingredient} is already in the selected list.`);
            }
        }

        /**
         * Removes an ingredient from the selected ingredients list.
         * @param {string} ingredientToRemove - The ingredient to remove.
         */
        function removeIngredientFromSelectedList(ingredientToRemove) {
            selectedIngredients = selectedIngredients.filter(ingredient => ingredient !== ingredientToRemove);
            renderSelectedIngredients(); // Update the display
            console.log(`Removed from selected list: ${ingredientToRemove}`);
        }

        /**
         * Clears all ingredients from the selected ingredients list.
         */
        function clearSelectedIngredients() {
            selectedIngredients = []; // Empty the array
            renderSelectedIngredients(); // Re-render to update the UI
            console.log('All selected ingredients cleared.');
        }

        /**
         * Performs the ingredient search based on user input.
         * Displays matching ingredients or a "no results" message.
         */
        function performSearch() {
            const query = searchInput.value.trim().toLowerCase(); // Get and format the search query
            resultsList.innerHTML = ''; // Clear previous results
            noResultsMessage.classList.add('hidden'); // Hide "no results" message
            searchResultsDiv.classList.add('hidden'); // Hide results container by default

            if (query) {
                // Filter the ingredient list based on the query (now using allIngredientsData)
                const filteredIngredients = allIngredientsData.filter(ingredient =>
                    ingredient.includes(query)
                );

                if (filteredIngredients.length > 0) {
                    searchResultsDiv.classList.remove('hidden'); // Show the results container
                    // Add matching ingredients to the list
                    filteredIngredients.forEach(ingredient => {
                        const listItem = document.createElement('li');
                        // Capitalize the first letter for display
                        listItem.textContent = ingredient.charAt(0).toUpperCase() + ingredient.slice(1); // Capitalize first letter
                        listItem.classList.add('ingredient-item'); // Add class for styling
                        listItem.addEventListener('click', () => {
                            addIngredientToSelectedList(ingredient); // Add to selected list on click
                            searchInput.value = ''; // Clear search input after selection
                            searchResultsDiv.classList.add('hidden'); // Hide search results after selection
                        });
                        resultsList.appendChild(listItem);
                    });
                } else {
                    searchResultsDiv.classList.remove('hidden'); // Show the results container
                    noResultsMessage.classList.remove('hidden'); // Show "no results" message
                }
            } else {
                console.log('Search field is empty.');
            }
        }

        /**
         * Suggests recipes based on selected ingredients and the active meal type filter.
         * Displays matching recipes or a "no suggested recipes" message.
         */
        function suggestRecipes() {
            recipesList.innerHTML = ''; // Clear previous recipes
            noSuggestedRecipesMessage.classList.add('hidden'); // Hide "no suggestions" message

            // If no ingredients are selected and the filter is 'alle', show the default message
            if (selectedIngredients.length === 0 && currentMealTypeFilter === 'alle') {
                noSuggestedRecipesMessage.classList.remove('hidden');
                noSuggestedRecipesMessage.textContent = "Legg til ingredienser for å få oppskriftsforslag.";
                return;
            }

            let filteredRecipesByType = recipesData; // Start with all recipes
            if (currentMealTypeFilter !== 'alle') {
                // Filter recipes by meal type if a specific filter is active
                filteredRecipesByType = recipesData.filter(recipe => recipe.type === currentMealTypeFilter);
            }

            let matchingRecipes = [];

            filteredRecipesByType.forEach(recipe => {
                let matchedCount = 0;
                let missingIngredients = [];

                recipe.ingredients.forEach(requiredIngredient => {
                    if (selectedIngredients.includes(requiredIngredient)) {
                        matchedCount++;
                    } else {
                        missingIngredients.push(requiredIngredient);
                    }
                });

                // Add the recipe if it has at least one matching ingredient OR if no ingredients are selected but a filter is active
                // This logic ensures that if you select a filter (e.g., "Middag") and have no ingredients,
                // it will still show all "Middag" recipes.
                if (matchedCount > 0 || (selectedIngredients.length === 0 && currentMealTypeFilter !== 'alle')) {
                    matchingRecipes.push({
                        name: recipe.name,
                        matched: matchedCount,
                        total: recipe.ingredients.length,
                        missing: missingIngredients,
                        url: recipe.url,
                        type: recipe.type
                    });
                }
            });

            // If no ingredients are selected but a filter is active, show all recipes of that type
            if (selectedIngredients.length === 0 && currentMealTypeFilter !== 'alle') {
                matchingRecipes = filteredRecipesByType.map(recipe => ({
                    name: recipe.name,
                    matched: 0, // No matched ingredients
                    total: recipe.ingredients.length,
                    missing: recipe.ingredients, // All ingredients are missing
                    url: recipe.url,
                    type: recipe.type
                }));
            }


            // Sort recipes by the number of matching ingredients (most first)
            matchingRecipes.sort((a, b) => b.matched - a.matched);

            if (matchingRecipes.length > 0) {
                matchingRecipes.forEach(recipe => {
                    const recipeCard = document.createElement('div');
                    recipeCard.classList.add('recipe-card');

                    // Create a link for the recipe name
                    const recipeLink = document.createElement('a');
                    recipeLink.href = recipe.url;
                    recipeLink.target = "_blank"; // Open in new tab
                    recipeLink.rel = "noopener noreferrer"; // Security for _blank

                    const recipeName = document.createElement('h3');
                    recipeName.textContent = recipe.name;
                    recipeLink.appendChild(recipeName); // Put the name inside the link
                    recipeCard.appendChild(recipeLink); // Add the link to the card

                    const matchedInfo = document.createElement('p');
                    matchedInfo.classList.add('matched-ingredients');
                    matchedInfo.textContent = `Du har ${recipe.matched} av ${recipe.total} ingredienser.`;
                    recipeCard.appendChild(matchedInfo);

                    if (recipe.missing.length > 0) {
                        const missingInfo = document.createElement('p');
                        missingInfo.classList.add('missing-ingredients');
                        // Capitalize first letter of each missing ingredient for display
                        missingInfo.textContent = `Mangler: ${recipe.missing.map(i => i.charAt(0).toUpperCase() + i.slice(1)).join(', ')}`;
                        recipeCard.appendChild(missingInfo);
                    }

                    recipesList.appendChild(recipeCard);
                });
            } else {
                noSuggestedRecipesMessage.classList.remove('hidden');
                noSuggestedRecipesMessage.textContent = "Ingen oppskrifter funnet med de valgte ingrediensene og filteret.";
            }
        }

        // Add event listeners for filter buttons
        mealTypeFilters.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove 'active' class from all buttons
                mealTypeFilters.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                // Add 'active' class to the clicked button
                button.classList.add('active');
                currentMealTypeFilter = button.dataset.filter; // Update the filter
                suggestRecipes(); // Update recipes based on new filter
            });
        });


        // Add event listener for click on the search button
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('input', performSearch);
        

        // New: Add event listener for the "Clear All" button
        clearSelectedButton.addEventListener('click', clearSelectedIngredients);


        // Fetch data from data.json when the page loads
        // Show loading overlay before fetch
        loadingOverlay.classList.remove('hidden');
        fetch('data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                allIngredientsData = data.ingredients;
                recipesData = data.recipes;
                console.log('Data loaded:', allIngredientsData, recipesData);
                // Initialize the view AFTER the data is loaded
                renderSelectedIngredients(); // This will also call suggestRecipes
            })
            .catch(error => {
                console.error('Could not load data.json:', error);
                // Display an error message to the user using the custom modal
                showModal("Feil ved lasting av data", "Kunne ikke laste ingredienser og oppskrifter. Prøv igjen senere.");
                noResultsMessage.textContent = "Kunne ikke laste ingredienser og oppskrifter. Prøv igjen senere.";
                noResultsMessage.classList.remove('hidden');
            })
            .finally(() => {
                // Hide loading overlay after fetch completes (either success or error)
                loadingOverlay.classList.add('hidden');
            });

    </script>
</body>
</html>
